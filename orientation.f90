!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

subroutine Atransf(chi,eta,xi,zeta,At)
implicit none
!!===========================================
! The main purpose of this subroutine is
! calculate transformation matrix
! using quaternion parameters
!!===========================================
double precision	chi, eta, xi, zeta
double precision	At(3,3)
!!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
At(1,1) = - zeta**2.d0 + eta**2.d0 - xi**2.d0 + chi**2.d0
At(1,2) = 2.d0*(zeta*chi - xi*eta)
At(1,3) = 2.d0*(eta*zeta + xi*chi)

At(2,1) = -2.d0*(xi*eta + zeta*chi)
At(2,2) = - zeta**2.d0 - eta**2.d0 + xi**2.d0 + chi**2.d0
At(2,3) = 2.d0*(eta*chi - xi*zeta)

At(3,1) = 2.d0*(eta*zeta - xi*chi)
At(3,2) = -2.d0*(xi*zeta + eta*chi)
At(3,3) = zeta**2.d0 - eta**2.d0 - xi**2.d0 + chi**2.d0
!!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
end subroutine Atransf
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
subroutine quat21(chiJ,etaJ,xiJ,zetaJ,chiI,etaI,xiI,zetaI,chiJI,etaJI,xiJI,zetaJI)
implicit none
!!===========================================
! The main purpose of this subroutine is
! calculate orientation of particle 2 (J)
! relative to particle 1 (I)
!!===========================================
double precision	chiI, etaI, xiI, zetaI
double precision	chiJ, etaJ, xiJ, zetaJ
double precision	mod
double precision	chiJI, etaJI, xiJI, zetaJI
!!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!! quaternions of particle 2 (J) relative to particle 1 (I)
chiJI =  chiI*chiJ + etaI*etaJ + xiI*xiJ + zetaI*zetaJ
etaJI =- etaI*chiJ + chiI*etaJ - zetaI*xiJ + xiI*zetaJ
xiJI  = - xiI*chiJ + zetaI*etaJ + chiI*xiJ - etaI*zetaJ
zetaJI=-zetaI*chiJ -  xiI*etaJ + etaI*xiJ + chiI*zetaJ
!!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

mod = sqrt(chiJI**2.d0 + etaJI**2.d0 + xiJI**2.d0 + zetaJI**2.d0)
chiJI = chiJI/mod
etaJI = etaJI/mod
xiJI  = xiJI/mod
zetaJI= zetaJI/mod

end subroutine quat21
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
subroutine eigenval(Q,Sx)
implicit none
!!===========================================
! The main purpose of this subroutine is
! calculate eigenvalues of a matrix 3x3
!!===========================================
double precision	Q(3,3)

double precision	a, b, c, d, e, f

double precision	l1, l2, l3, Sx
!!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
a = Q(1,1)
b = Q(1,2)
d = Q(2,2)
!! a, b, c
!! b, d, e
!! c, e, f
!!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!! Eigenvalues
!l1 = 0.50*(a + d - sqrt(a**2.0 + 4.0*b**2.0 - 2.0*a*d + d**2.0) )
l2 = 0.50*(a + d + sqrt(a**2.0 + 4.0*b**2.0 - 2.0*a*d + d**2.0) )
!l3 = Q(3,3)
!!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!write(*,*) Q(1,1), Q(1,2), Q(1,3)
!write(*,*) Q(2,1), Q(2,2), Q(2,3)
!write(*,*) Q(3,1), Q(3,2), Q(3,3)
!write(*,*) '------'
!write(*,*) l1, l2, l3
!write(*,*) '------'

Sx = abs(l2)

end subroutine eigenval
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
subroutine Q2dist(x,p2)
implicit none
!!===========================================
! The main purpose of this subroutine is
! calculate legendre polynomials of x
!!===========================================
double precision	x
double precision	p2
!!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!! Second Legendre polynomial
!p2 = 0.50*(3.0*x**2.0 - 1.0)
p2 = (2.0*x**2.0 - 1.0)
!!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

end subroutine Q2dist
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
subroutine Q4dist(A,B,p4)
COMMON / NUM_PAR / N
!!===========================================
! The main purpose of this subroutine is
! calculate legendre polynomials of x
!!===========================================
integer				N
double precision	A(3,3)
double precision	B(3,3)
double precision	x, p4
!!===========================================
!! See 
!! Thapar et al. Soft Matter, 2015, 11, 1481 DOI: 10.1039/c4sm02641a
!! Agarwal and Escobedo, Mat. Materials, 2011, 10, 230 DOI: 10.1038/NMAT2959
!!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!! "x-axis" of the particle in tha lab-coord.
!! Vx(:,1) = At11
!! Vx(:,2) = At12
!! Vx(:,3) = At13
!!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!! "y-axis" of the particle in tha lab-coord.
!! Vy(:,1) = At21
!! Vy(:,2) = At22
!! Vy(:,3) = At23
!!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!! "z-axis" of the particle in tha lab-coord.
!! Vz(:,1) = At31
!! Vz(:,2) = At32
!! Vz(:,3) = At33
!!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!! Fourth Legendre polynomial
p4 = 0.d0
x = A(1,1)*B(1,1) + A(1,2)*B(1,2) + A(1,3)*B(1,3)
p4 = p4 + 0.125*(35.0*x**4.0 - 30.0*x**2.0 + 3.0)/6.0

x = A(1,1)*B(2,1) + A(1,2)*B(2,2) + A(1,3)*B(2,3)
p4 = p4 + 0.125*(35.0*x**4.0 - 30.0*x**2.0 + 3.0)/6.0

x = A(1,1)*B(3,1) + A(1,2)*B(3,2) + A(1,3)*B(3,3)
p4 = p4 + 0.125*(35.0*x**4.0 - 30.0*x**2.0 + 3.0)/6.0
!!
x = A(2,1)*B(1,1) + A(2,2)*B(1,2) + A(2,3)*B(1,3)
p4 = p4 + 0.125*(35.0*x**4.0 - 30.0*x**2.0 + 3.0)/6.0

x = A(2,1)*B(2,1) + A(2,2)*B(2,2) + A(2,3)*B(2,3)
p4 = p4 + 0.125*(35.0*x**4.0 - 30.0*x**2.0 + 3.0)/6.0

x = A(2,1)*B(3,1) + A(2,2)*B(3,2) + A(2,3)*B(3,3)
p4 = p4 + 0.125*(35.0*x**4.0 - 30.0*x**2.0 + 3.0)/6.0
!!
!!x = A(3,1)*B(1,1) + A(3,2)*B(1,2) + A(3,3)*B(1,3)
!!p4 = p4 + 0.125*(35.0*x**4.0 - 30.0*x**2.0 + 3.0)/9.0

!!x = A(3,1)*B(2,1) + A(3,2)*B(2,2) + A(3,3)*B(2,3)
!!p4 = p4 + 0.125*(35.0*x**4.0 - 30.0*x**2.0 + 3.0)/9.0

!!x = A(3,1)*B(3,1) + A(3,2)*B(3,2) + A(3,3)*B(3,3)
!!p4 = p4 + 0.125*(35.0*x**4.0 - 30.0*x**2.0 + 3.0)/9.0

p4 = p4/real(N)
!!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
end subroutine Q4dist
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



